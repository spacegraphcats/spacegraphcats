
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="http://spacegraphcats.github.io/spacegraphcats/02-spacegraphcats-use-cases/">
      
      
        <link rel="prev" href="../01-running-spacegraphcats/">
      
      
        <link rel="next" href="../03-visualizing-spacegraphcats/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.4.7">
    
    
      
        <title>Spacegraphcats use cases - spacegraphcats documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.4b4a2bd9.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.356b1318.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue_grey" data-md-color-accent="black">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#spacegraphcats-use-cases-and-working-with-the-output" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="spacegraphcats documentation" class="md-header__button md-logo" aria-label="spacegraphcats documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m21 12-7-7v4C7 10 4 15 3 20c2.5-3.5 6-5.1 11-5.1V19l7-7Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            spacegraphcats documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Spacegraphcats use cases
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/spacegraphcats/spacegraphcats" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    spacegraphcats
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="spacegraphcats documentation" class="md-nav__button md-logo" aria-label="spacegraphcats documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m21 12-7-7v4C7 10 4 15 3 20c2.5-3.5 6-5.1 11-5.1V19l7-7Z"/></svg>

    </a>
    spacegraphcats documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/spacegraphcats/spacegraphcats" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    spacegraphcats
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../0a-primer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Primer on metagenomics and assembly graphs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Using spacegraphcats
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Using spacegraphcats
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../00-installing-spacegraphcats/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installing spacegraphcats
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../01-running-spacegraphcats/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Running spacegraphcats
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Spacegraphcats use cases
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Spacegraphcats use cases
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#installing-the-spacegraphcats-software-and-its-dependencies" class="md-nav__link">
    Installing the spacegraphcats software and its dependencies
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spacegraphcats-use-cases" class="md-nav__link">
    Spacegraphcats use cases
  </a>
  
    <nav class="md-nav" aria-label="Spacegraphcats use cases">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#metagenome-bin-completion" class="md-nav__link">
    Metagenome bin completion
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#identifying-the-context-of-eg-horizontally-transferred-genes" class="md-nav__link">
    Identifying the context of e.g. horizontally transferred genes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#working-with-spacegraphcats-results" class="md-nav__link">
    Working with spacegraphcats results
  </a>
  
    <nav class="md-nav" aria-label="Working with spacegraphcats results">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#try-an-amino-acid-assembler" class="md-nav__link">
    Try an amino acid assembler
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-read-level-analysis-tools" class="md-nav__link">
    Use read-level analysis tools
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../03-visualizing-spacegraphcats/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Visualizing spacegraphcats outputs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../04-spacegraphcats-parameters/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tuning parameters in spacegraphcats
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../05-alpha-spacegraphcats/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Alpha functionality in spacegraphcats
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../06-snakemake-spacegraphcats/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Integrating spacegraphcats into a snakemake workflow
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../calculating-taxonomic-purity/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Calculating taxonomic purity of spacegraphcats outputs
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../developing-spacegraphcats/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Developer's guide
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#installing-the-spacegraphcats-software-and-its-dependencies" class="md-nav__link">
    Installing the spacegraphcats software and its dependencies
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spacegraphcats-use-cases" class="md-nav__link">
    Spacegraphcats use cases
  </a>
  
    <nav class="md-nav" aria-label="Spacegraphcats use cases">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#metagenome-bin-completion" class="md-nav__link">
    Metagenome bin completion
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#identifying-the-context-of-eg-horizontally-transferred-genes" class="md-nav__link">
    Identifying the context of e.g. horizontally transferred genes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#working-with-spacegraphcats-results" class="md-nav__link">
    Working with spacegraphcats results
  </a>
  
    <nav class="md-nav" aria-label="Working with spacegraphcats results">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#try-an-amino-acid-assembler" class="md-nav__link">
    Try an amino acid assembler
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-read-level-analysis-tools" class="md-nav__link">
    Use read-level analysis tools
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="spacegraphcats-use-cases-and-working-with-the-output">spacegraphcats: use cases and working with the output</h1>
<h2 id="installing-the-spacegraphcats-software-and-its-dependencies">Installing the spacegraphcats software and its dependencies</h2>
<p>Please see <a href="../00-installing-spacegraphcats/">Installing spacegraphcats</a>.</p>
<h2 id="spacegraphcats-use-cases">Spacegraphcats use cases</h2>
<h3 id="metagenome-bin-completion">Metagenome bin completion</h3>
<p>As discussed in the <a href="../0a-primer/">primer on metagenomics and assembly graphs</a>, assembly and binning are lossy processes that leave many reads uncharacterized in metagenome analysis. 
Spacegraphcats can be used to recover unassembled and unbinned reads that "belong" to a metagenome bin by using the metagenome bin as a query. 
We recommend using the <a href="https://metagenome-atlas.readthedocs.io/en/latest/">Atlas</a> automated metagenome analysis pipeline to produce the initial bins. 
(Alternatively, the <a href="https://github.com/dib-lab/genome-grist">genome-grist</a> pipeline may be used to identify the list of known reference genomes to be used as queries for a metagenome.)
Then, each bin can be used as a query, producing a query neighborhood that reassociates unassembled and unbinned reads that are graph-adjacent to the query.<br />
In a metagenome from an oil reservoir, bin completion with spacegraphcats identified strain-variable regions in genes that were present in the bin (e.g. <em>gyrA</em> in panel A of the figure below) and identified unbinned genes that augmented the functional content of the metagenome by 13% (panel B of the figure below).</p>
<p><img alt="" src="https://media.springernature.com/full/springer-static/image/art%3A10.1186%2Fs13059-020-02066-4/MediaObjects/13059_2020_2066_Fig4_HTML.png?as=webp" /> <em>Source: <a href="https://doi.org/10.1186/s13059-020-02066-4">Brown et al. 2020</a></em></p>
<p>Install companion software:</p>
<pre><code>conda install sourmash fastp khmer
</code></pre>
<p>Download data:</p>
<pre><code>wget ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR197/008/SRR1976948/SRR1976948_1.fastq.gz
wget ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR197/008/SRR1976948/SRR1976948_2.fastq.gz
</code></pre>
<p>Adapter trim the data:</p>
<pre><code>fastp --in1 SRR1976948_1.fastq.gz \
  --in2 SRR1976948_2.fastq.gz \
  --out1 SRR1976948_1.trim.fastq.gz \
  --out2 SRR1976948_2.trim.fastq.gz \
  --detect_adapter_for_pe \
  --qualified_quality_phred 4 \
  --length_required 31 --correction \
  --json SRR1976948.trim.json \
  --html SRR1976948.trim.html
</code></pre>
<p>k-mer trim the data:</p>
<pre><code>interleave-reads.py SRR1976948_1.trim.fastq.gz SRR1976948_2.trim.fastq.gz | \
        trim-low-abund.py --gzip -C 3 -Z 18 -M 20e9 -V - -o SRR1976948.abundtrim.fq.gz
</code></pre>
<p>Download the query genome (this is a metagenome bin produced from SRR1976948):</p>
<pre><code>wget ftp://ftp.ncbi.nlm.nih.gov/genomes/all/GCA/001/508/995/GCA_001508995.1_ASM150899v1/GCA_001508995.1_ASM150899v1_genomic.fna.gz
</code></pre>
<p>Configuration file, saved as <code>conf1.yml</code>.
Note that configuration files may contain multiple input sequences from which to build the cDBG and catlas, or multiple search fasta files. </p>
<pre><code>catlas_base: 'SRR1976948'
input_sequences:
- SRR1976948.abundtrim.fq.gz
ksize: 31
radius: 1
search:
- GCA_001508995.1_ASM150899v1_genomic.fna.gz
</code></pre>
<p>run spacegraphcats:</p>
<pre><code>python -m spacegraphcats run conf1.yml extract_contigs extract_reads --nolock 
</code></pre>
<p>compare the output sequences:</p>
<pre><code>sourmash compute -k 21,31,51 --scaled 2000 -o GCA_001508995.1_ASM150899v1_genomic.sig GCA_001508995.1_ASM150899v1_genomic.fna.gz
sourmash compare -k 31 --csv comp.csv *sig SRR1976948_k31_r1_search_oh0/*sig
</code></pre>
<p>Publications using this approach are listed below:</p>
<ol>
<li>Brown, C.T., Moritz, D., Oâ€™Brien, M.P. et al. Exploring neighborhoods in large metagenome assembly graphs using spacegraphcats reveals hidden sequence diversity. Genome Biol 21, 164 (2020). https://doi.org/10.1186/s13059-020-02066-4</li>
<li>Lumian, J.E., Jungblut, A.D., Dillion, M.L. et al. Metabolic Capacity of the Antarctic Cyanobacterium Phormidium pseudopriestleyi That Sustains Oxygenic Photosynthesis in the Presence of Hydrogen Sulfide. Genes 12, 426 (2021). https://doi.org/10.3390/genes12030426 </li>
</ol>
<h3 id="identifying-the-context-of-eg-horizontally-transferred-genes">Identifying the context of e.g. horizontally transferred genes</h3>
<p>Spacegraphcats queries don't need to be an entire genome, but can be any size (greater than <em>k</em>). 
For example, one can query with a gene of interest. 
In the example below, we identify antibiotic resistance genes in time series human stool metagenomes using <a href="https://github.com/will-rowe/groot">GROOT</a>, and then use the identified genes as spacegraphcats queries.
Using this method, we can see how the context of antibiotic resistance genes changes over time.</p>
<p>The dataset used below is a time series from a single individual with Crohn's disease, sequenced by the <a href="https://ibdmdb.org/">Integrative Human Microbiome Project (iHMP)</a>.
The stool microbiome from this individual was sequenced at 12 different timepoints over 37 weeks, and the individual was on antibiotics at various times during the that timeframe.</p>
<p><img alt="" src="https://i.imgur.com/H7JiYvr.png" /> <em>Times of sequencing and antibiotic exposure for individual H4017 from the Integrative Human Microbiome Project.</em></p>
<p>We'll determine the sequence context of one antibiotic resistance gene in one sample using one radius. </p>
<p>Install companion software needed for this analysis:</p>
<pre><code>conda install 'sourmash&gt;=4.1.0,&lt;5' fastp=0.20.1 bbmap=38.70 khmer=3.0.0a3 groot=1.1.2 samtools=1.12 bandage=0.8.1 blast=2.11.0
</code></pre>
<p>Then, download the the sequencing data and perform quality control.
This sample was taken at week 25 when the individual was on antibiotics.</p>
<pre><code>mkdir -p inputs/raw
wget -O inputs/raw/HSM67VFJ.tar https://ibdmdb.org/tunnel/static/HMP2/WGS/1818/HSM67VFJ.tar
tar xf inputs/raw/HSM67VFJ.tar -C inputs/raw
</code></pre>
<p>Adapter trim and (lightly) quality trim with fastp:</p>
<pre><code>mkdir -p outputs/fastp
fastp --in1 inputs/raw/HSM67VFJ_R1.fastq.gz \
      --in2 inputs/raw/HSM67VFJ_R2.fastq.gz \
      --out1 outputs/fastp/HSM67VFJ_R1.trim.fq.gz \
      --out2 outputs/fastp/HSM67VFJ_R2.trim.fq.gz \
      --detect_adapter_for_pe \
      --qualified_quality_phred 4 \
      --length_required 31 --correction \
      --json outputs/fastp/HSM67VFJ.json \
      --html outputs/fastp/HSM67VFJ.html
</code></pre>
<p>Remove "host" (e.g. human) DNA from the sequencing reads
You will need the masked human k-mer data available <a href="https://drive.google.com/file/d/0B3llHR93L14wd0pSSnFULUlhcUk/edit?usp=sharing">here</a>.
Download and save this file to <code>inputs/host/inputs/host/hg19_main_mask_ribo_animal_allplant_allfungus.fa.gz</code>.
This step can take up to 64GB of ram.
To reduce this, change <code>-Xmx64g</code> to a lower number, e.g. <code>-Xmx16g</code>.</p>
<pre><code>mkdir -p outputs/bbduk
bbduk.sh -Xmx64g t=3 k=31 \
     in=outputs/fastp/HSM67VFJ_R1.trim.fq.gz \
     in2=outputs/fastp/HSM67VFJ_R2.trim.fq.gz \
     out=outputs/bbduk/HSM67VFJ_R1.nohost.fq.gz \
     out2=outputs/bbduk/HSM67VFJ_R2.nohost.fq.gz \
     outm=outputs/bbduk/HSM67VFJ_R1.human.fq.gz \
     outm2=outputs/bbduk/HSM67VFJ_R2.human.fq.gz \
     ref=inputs/host/hg19_main_mask_ribo_animal_allplant_allfungus.fa.gz
</code></pre>
<p>K-mer trim the reads.
This step can take up to 60GB of ram as written.
To reduce this, change <code>-M 60e9</code> to a lower number, e.g. <code>-M 16e9</code>. </p>
<pre><code>mkdir -p outputs/abundtrim
interleave-reads.py outputs/bbduk/HSM67VFJ_R1.nohost.fq.gz outputs/bbduk/HSM67VFJ_R2.nohost.fq.gz | \
      trim-low-abund.py --gzip -C 3 -Z 18 -M 60e9 -V - -o outputs/abundtrim/HSM67VFJ.abundtrim.fq.gz
</code></pre>
<p>After quality control is complete, we'll use <a href="https://github.com/will-rowe/groot">Groot</a> to identify reads that encode antibiotic resistance genes. 
Groot uses a database from which it identifies genes of interest. 
Download the ARG90 database:</p>
<pre><code>groot get -d arg-annot
</code></pre>
<p>Then, index the database. <code>-p</code> specifies how many threads to use during indexing.</p>
<pre><code>groot index -m arg-annot.90 -i groot-index -w 100 -p 8
</code></pre>
<p>Run groot on the sequencing reads:</p>
<pre><code>mkdir outputs/groot
groot align -i groot-index -f outputs/abundtrim/HSM67VFJ.abundtrim.fq.gz \
  -p 2 -g outputs/groot/HSM67VFJ_arg90.graph &gt; outputs/groot/HSM67VFJ_arg90.bam
</code></pre>
<p>And generate a report that summarizes the antibiotic resistance reads identified.
<code>-c</code> indicates the amount of coverage for a gene to be reported.</p>
<pre><code>groot report --bamFile outputs/groot/HSM67VFJ_arg90.bam -c .9 &gt; outputs/groot/HSM67VFJ_arg90_report.txt
</code></pre>
<p>The <code>groot report</code> function produces the following report:</p>
<pre><code>argannot~~~(Bla)cfxA5~~~AY769934:28-993 1452    966     776M1D186M3D
argannot~~~(Bla)cfxA~~~U38243:150-1115  1551    966     886M80D
argannot~~~(Bla)CEP-A-44~~~U05885:556-1458      624     903     613M2D287M1D
argannot~~~(Bla)cfxA4~~~AY769933:1-966  1453    966     963M3D
argannot~~~(Tet)TetW~~~AJ222769:3687-5606       154     1920    44D1851M25D
argannot~~~(Bla)cfxA2~~~AF504910:1-966  1606    966     501M6D456M3D
</code></pre>
<p>The columns specify <code>"arg", "read_count", "gene_length", "coverage"</code> of each antibiotic resistance gene in the sequencing sample.</p>
<p>Using the bam file which recorded which reads map to which antibiotic resistance genes, we can estimate the proportion of reads that mapped to any ARG.</p>
<pre><code>mapped=$(samtools view -c -F 4 outputs/groot/HSM67VFJ_arg90.bam)
proportion=$(echo &quot;scale=10 ; $mapped / 10000000&quot; | bc)
printf &quot;HSM67VFJ,$proportion&quot; &gt; outputs/groot/HSM67VFJ_proportion.txt
</code></pre>
<p>We see that for this sample, a small proportion of reads mapped against the ARG database</p>
<pre><code>HSM67VFJ,.0010801000
</code></pre>
<p>Now that we've identified which antibiotic resistance genes are in this sample, we can select one of them and use it as a spacegraphcats query to determine its context.
We'll start by downloading the FASTA sequences for antibiotic resistance genes in the ARG database and indexing those sequences with samtools.</p>
<pre><code>mkdir -p inputs/arg_db
wget -O inputs/arg_db/argannot-args.fna https://github.com/will-rowe/groot/raw/master/db/full-ARG-databases/arg-annot-db/argannot-args.fna
samtools faidx inputs/arg_db/argannot-args.fna
</code></pre>
<p>Then, extract a single sequence that was identified in the sample.</p>
<pre><code>mkdir -p outputs/arg90_matches
samtools faidx inputs/arg_db/argannot-args.fna argannot~~~(Bla)cfxA4~~~AY769933:1-966 &gt; outputs/arg90_matches/cfxA4_AY769933.fna
</code></pre>
<p>Make a configuration file for spacegraphcats, and save it as <code>outputs/sgc_conf/HSM67VFJ_r1_conf.yml</code>.</p>
<pre><code>catlas_base: HSM67VFJ
input_sequences:
- outputs/abundtrim/HSM67VFJ.abundtrim.fq.gz
ksize: 31
radius: 1
search:
- outputs/arg90_matches/cfxA4_AY769933.fna
</code></pre>
<p>Run spacegraphcats to extract the sequence context around the antibiotic resistance gene.</p>
<pre><code>python -m spacegraphcats run \
     outputs/sgc_conf/HSM67VFJ_r1_conf.yml \
     extract_contigs extract_reads \
     --nolock --outdir=outputs/sgc_arg_queries_r1 \
     --rerun-incomplete 
</code></pre>
<p>Lastly, use bcalm and bandage to plot the context extracted by spacegraphcats.</p>
<pre><code>mkdir -p outputs/bcalm/HSM67VFJ_r1
bcalm -in outputs/sgc_arg_queries_r1/HSM67VFJ_k31_r1_search_oh0/cfxA4_AY769933.fna.cdbg_ids.reads.gz \
     -out-dir outputs/bcalm/HSM67VFJ_r1 \
     -kmer-size 31 -abundance-min 1 \
     -out outputs/bcalm/HSM67VFJ_r1/cfxA4_AY769933.fna.cdbg_ids.reads.gz
</code></pre>
<p>Download the script to convert the bcalm file to a gfa file</p>
<pre><code>wget https://raw.githubusercontent.com/spacegraphcats/2018-paper-spacegraphcats/master/pipeline-analyses/variant_snakemake/convertToGFA.py
chmod 777 convertToGFA.py
python ./convertToGFA.py outputs/bcalm/HSM67VFJ_r1/cfxA4_AY769933.fna.cdbg_ids.reads.gz.unitigs.fa outputs/bcalm/HSM67VFJ_r1/cfxA4_AY769933.fna.cdbg_ids.reads.gz.unitigs.gfa 31
</code></pre>
<p>Use the bandage command line cli to plot the results with the antibiotic resistance gene highlighted.</p>
<pre><code>mkdir -p outputs/bandage
Bandage image outputs/bcalm/HSM67VFJ_r1/cfxA4_AY769933.fna.cdbg_ids.reads.gz.unitigs.gfa \
     outputs/bandage/HSM67VFJ_r1/cfxA4_AY769933.fna.cdbg_ids.reads.gz.unitigs.png \
     --query outputs/arg90_matches/cfxA4_AY769933.fna
</code></pre>
<p>A snakemake pipeline encoding this workflow is available <a href="https://github.com/taylorreiter/2021-sgc-arg">here</a>.
Running this workflow on all samples in the times series, we see that the context of the antibiotic resistance gene <em>cfxA4</em> changes over time.
Additionallly, using different radius sizes, we can see that the amount of sequencing context we get back increases with increasing radius size.</p>
<p><img alt="" src="https://i.imgur.com/jM3Lets.png" /> <em>Sequence context of antibiotic resistance gene cfxA4 over time and at different radiuses.</em></p>
<h2 id="working-with-spacegraphcats-results">Working with spacegraphcats results</h2>
<p>spacegraphcats is a powerful framework to organize and access unassembled reads in metagenomes, but the output is admittedly unsatisfying. 
While spacegraphcats will give you the reads or k-mers in the neighborhood of your query, often times the reads you're most interested in are the ones that are the most difficult to work with -- the ones that:</p>
<ol>
<li>do not assemble</li>
<li>do not match any sequences in databases</li>
</ol>
<p>We have some experiences with working with these kinds of reads and outline some approaches we have taken to working with them in the past. 
This is still an active area of research that can benefit from the creativity of the metagenomics community!</p>
<h3 id="try-an-amino-acid-assembler">Try an amino acid assembler</h3>
<p>Sometimes reads do not assemble due to excessive strain variation.
Amino acid assemblers reduce strain variation by translating reads into amino acid sequences prior to assembly.
In particular, this reduces strain variation due to third base pair wobble, where in the third nucleotide in a codon can vary without changing the amino acid which it encodes.</p>
<p>In the past, we have used the <a href="https://github.com/soedinglab/plass">PLASS</a> amino acid assembler somewhat successfully on spacegraphcats query neighborhoods.
However, PLASS seems to produce many potential amino acid sequences at least in part influenced by combinatorial overlaps in potential protein sequences.
This output can be difficult to wade through.</p>
<p>Amino acid assemblers only produce amino acid sequences. 
To map sequencing reads back to the assembly to estimate coverage depth or number of reads assembled, we have used <a href="https://github.com/ToniWestbrook/paladin">paladin</a> to map nucleotide reads to the amino acid assembly.</p>
<h3 id="use-read-level-analysis-tools">Use read-level analysis tools</h3>
<p>Tools like <a href="https://bromberglab.org/project/mifaser/">mifaser</a> and <a href="https://github.com/will-rowe/groot">GROOT</a> perform annotation on reads instead of on assemblies. 
These tools may provide insight into the content of a spacegraphcats query neighborhood.</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2021 <a href="http://ivory.idyll.org/lab/">Lab for Data Intensive Biology</a> at UC Davis and <a href="https://www.cs.utah.edu/~sullivan/#!/">Theory in Practice Lab at University of Utah
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.aecac24b.min.js"></script>
      
    
  </body>
</html>